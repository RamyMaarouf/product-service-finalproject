
use actix_cors::Cors;
use actix_web::dev::Server;
use actix_web::middleware::Logger;
use actix_web::{middleware, web, App, HttpServer};


use std::sync::Mutex;
use crate::configuration::Settings;
use crate::routes::*;
use crate::model::Product;
use crate::data::fetch_products;


pub fn run(mut settings: Settings) -> Result<Server, std::io::Error> {
    
    let mut products = fetch_products(&settings); // <-- mutable now

    if products.is_empty() {
        products = vec![
            Product { id: 1, name: "Sample Product 1".to_string(), price: 9.99 },
            Product { id: 2, name: "Sample Product 2".to_string(), price: 19.99 },
            Product { id: 3, name: "Sample Product 3".to_string(), price: 29.99 },
            Product { id: 4, name: "Sample Product 4".to_string(), price: 39.99 },
            Product { id: 5, name: "Sample Product 5".to_string(), price: 49.99 },
        ];
    }

    let product_state = web::Data::new(AppState {
        products: Mutex::new(products),
        settings: settings,
    });

    // ... rest of your server code remains the same
}


    let server = HttpServer::new(move || {
        
        let cors = Cors::permissive();

        App::new()
        .wrap(cors)
        .wrap(Logger::default())
        .wrap(Logger::new("%a %{User-Agent}i"))
        .wrap(middleware::DefaultHeaders::new().add(("X-Version", "0.2")))
        .app_data(product_state.clone())
        .route("/health", web::get().to(health))
        .route("/health", web::head().to(health))
        .route("/products", web::get().to(get_products))                // list first
        .route("/products/{product_id}", web::get().to(get_product))    // then single product
        .route("/products", web::post().to(add_product))
        .route("/products/{product_id}", web::delete().to(delete_product))
        .route("/ai/health", web::get().to(ai_health))
        .route("/ai/health", web::head().to(ai_health))
        .route(
            "/ai/generate/description",
            web::post().to(ai_generate_description),
        )
        .route(
            "/ai/generate/image",
            web::post().to(ai_generate_image),
        )
    })
    .listen(listener)?
    .run();

    Ok(server)
}

pub struct AppState {
    pub products: Mutex<Vec<Product>>,
    pub settings: Settings,
}


